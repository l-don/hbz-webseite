<div class="main">
  <app-banner-img [imgSrc]="'assets/banner/Bannerfoto_Anmeldung.jpg'"></app-banner-img>
  <div class="container">
    <h1 class="heading intro-text">Anmeldung</h1>
    <h1>Anmeldung</h1>

    <div class="reg-container">
      <form [formGroup]="form" (ngSubmit)="submit()" novalidate>

        <div class="reg-section">
          <ng-container *ngIf="events.length > 1; else singleEvent">
            <label for="event">Veranstaltung</label>
            <select id="event" formControlName="event_id">
              <option *ngFor="let e of events" [value]="e.id">{{ e.title }}</option>
            </select>
          </ng-container>
          <ng-template #singleEvent>
            <p><strong>Veranstaltung:</strong> {{ events[0].title }}</p>
          </ng-template>

          <h2>Buchungsdaten</h2>
          <div class="grid">
            <div>
              <div class="error-text" *ngIf="submitted && form.get('email')?.hasError('required')">Pflichtfeld</div>
              <label>Email
                <input type="email" placeholder="name@example.com" formControlName="email" />
              </label>
            </div>
            <div>
              <div class="error-text" *ngIf="submitted && form.get('phone')?.hasError('required')">Pflichtfeld</div>
              <label>Telefon
                <input type="tel" placeholder="+49 ..." formControlName="phone" />
              </label>
            </div>
            <div>
              <div class="error-text" *ngIf="submitted && form.get('emergency_contact_name')?.hasError('required')">Pflichtfeld</div>
              <label>Notfallkontakt Name
                <input type="text" placeholder="Name" formControlName="emergency_contact_name" />
              </label>
            </div>
            <div>
              <div class="error-text" *ngIf="submitted && form.get('emergency_contact_phone')?.hasError('required')">Pflichtfeld</div>
              <label>Notfallkontakt Nummer
                <input type="tel" placeholder="+49 ..." formControlName="emergency_contact_phone" />
              </label>
            </div>
            <label>Kommentar zur Buchung
              <textarea rows="3" placeholder="Anmerkungen" formControlName="comment"></textarea>
            </label>
          </div>
        </div>

        <div class="reg-section">
          <h2>Teilnehmende</h2>
          <div formArrayName="people">
            <div *ngFor="let p of people.controls; let i = index" [formGroupName]="i" class="person-card">
              <div class="person-header">
                <strong>Person {{ i + 1 }}</strong>
                <button type="button" class="btn-ghost" (click)="removePerson(i)" *ngIf="people.length > 1">Entfernen</button>
              </div>
              <div class="grid">
                <div>
                  <div class="error-text" *ngIf="submitted && i === 0 && p.get('firstname')?.hasError('required')">Pflichtfeld</div>
                  <label>Vorname
                    <input type="text" formControlName="firstname" />
                  </label>
                </div>
                <div>
                  <div class="error-text" *ngIf="submitted && i === 0 && p.get('lastname')?.hasError('required')">Pflichtfeld</div>
                  <label>Nachname
                    <input type="text" formControlName="lastname" />
                  </label>
                </div>
                <div>
                  <div class="error-text" *ngIf="submitted && i === 0 && p.get('birthday')?.hasError('required')">Pflichtfeld</div>
                  <label>Geburtsdatum
                    <input type="date" formControlName="birthday" />
                  </label>
                </div>
                <div>
                  <div class="error-text" *ngIf="submitted && i === 0 && p.get('address')?.hasError('required')">Pflichtfeld</div>
                  <label>Adresse
                    <input type="text" formControlName="address" />
                  </label>
                </div>
                <label>Kommentar
                  <input type="text" formControlName="comment" />
                </label>
              </div>
              <div class="flags">
                <label><input type="checkbox" formControlName="vegetarian" /> Vegetarisch</label>
                <label><input type="checkbox" formControlName="staff" /> Mitarbeiter</label>
                <label><input type="checkbox" formControlName="orga" /> Orga</label>
              </div>
            </div>
            <button type="button" class="custom-button-1" (click)="addPerson()">+ Person hinzufügen</button>
          </div>
        </div>

        <div class="reg-section">
          <h2>Zusatzoptionen</h2>
          <div formArrayName="items">
            <div *ngFor="let it of items.controls; let j = index" [formGroupName]="j" class="item-row">
              <label>Typ
                <select formControlName="type_id">
                  <option value="" disabled>Bitte wählen</option>
                  <option *ngFor="let t of itemTypes" [value]="t.id">{{ t.title }} ({{ t.price }}€)</option>
                </select>
              </label>
              <label>Kommentar
                <input type="text" formControlName="comment" />
              </label>
              <button type="button" class="btn-ghost" (click)="removeItem(j)">Entfernen</button>
            </div>
            <button type="button" class="custom-button-1" (click)="addItem()">+ Zusatz hinzufügen</button>
          </div>
        </div>

        <div class="form-error-banner" *ngIf="submitted && !canSubmit">
          <strong>Hinweis: <br>
            Bitte füllen Sie alle mit „Pflichtfeld“ markierten Felder aus.</strong><br>
           Zu jeder Buchung muss eine Email und Telefeonnummer zum Kontakt hinzugefügt werden. Außedem muss ein Notfallkontakt mit Name und Telefonnummer angegeben werden.<br>
          Für eine gültige Buchung muss außerdem mindestens eine Person mit Vorname, Nachname, Geburtsdatum und Adresse hinzugefügt werden.
        </div>

        <div class="actions">
          <a routerLink="/anmeldung" class="btn-secondary">Zurück</a>
          <button type="submit" [disabled]="isSaving" class="custom-button-1">Absenden</button>
        </div>

      </form>
    </div>
  </div>
</div>
